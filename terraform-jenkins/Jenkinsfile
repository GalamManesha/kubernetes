// Jenkinsfile - Declarative pipeline for Terraform (fixed; no unclosed strings)
pipeline {
  agent any

  parameters {
    string(name: 'GIT_URL', defaultValue: 'https://github.com/GalamManesha/kubernetes.git', description: 'Git repository URL')
    string(name: 'GIT_BRANCH', defaultValue: 'main', description: 'Git branch to checkout')
    booleanParam(name: 'AUTO_APPLY', defaultValue: true, description: 'If true, terraform apply will run automatically. If false, pipeline waits for human approval.')
  }

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    TERRAFORM_BIN = "/usr/local/bin/terraform"
  }

  options {
    buildDiscarder(logRotator(daysToKeepStr: '7'))
    timeout(time: 60, unit: 'MINUTES')
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Checking out ${params.GIT_URL} (${params.GIT_BRANCH})"
        git branch: params.GIT_BRANCH, url: params.GIT_URL
      }
    }

    stage('Preflight / Tools Check') {
      steps {
        script {
          def tf = sh(script: 'command -v terraform || echo ${TERRAFORM_BIN}', returnStdout: true).trim()
          env.TF_BIN = tf
          echo "Using Terraform: ${env.TF_BIN}"
        }
        // single-line to show version; use the resolved TF_BIN
        sh '${TF_BIN} --version'
      }
    }

    stage('Terraform Format & Validate') {
      steps {
        dir('.') {
          // multiline sh block - properly closed
          sh '''
            set -e
            ${TF_BIN} fmt -recursive || true
            ${TF_BIN} init -input=false
            ${TF_BIN} validate || true
          '''
        }
      }
    }

    stage('Terraform Plan') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          // create plan and show human-readable plan
          sh '''
            set -e
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            ${TF_BIN} init -input=false
            ${TF_BIN} plan -out=tfplan -input=false
            echo "---- terraform show (human readable) ----"
            ${TF_BIN} show -no-color tfplan
          '''
          archiveArtifacts artifacts: 'tfplan', onlyIfSuccessful: true
        }
      }
    }

    stage('Approve / Apply (manual)') {
      when {
        expression { return params.AUTO_APPLY == false }
      }
      steps {
        script {
          def user = input(id: 'ProceedApply', message: 'Approve terraform apply?', ok: 'Apply', parameters: [
            [$class: 'TextParameterDefinition', defaultValue: '', description: 'Optional comment', name: 'COMMENT']
          ])
          echo "Approved by: ${user}"
        }
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          sh '''
            set -e
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            ${TF_BIN} apply -auto-approve tfplan
          '''
        }
      }
    }

    stage('Auto-Apply (when enabled)') {
      when {
        expression { return params.AUTO_APPLY == true }
      }
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          sh '''
            set -e
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            ${TF_BIN} apply -auto-approve tfplan
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ Pipeline finished successfully."
    }
    failure {
      echo "❌ Pipeline failed — check console output and Terraform logs."
    }
    always {
      echo "Finished at: ${new Date()}"
    }
  }
}
