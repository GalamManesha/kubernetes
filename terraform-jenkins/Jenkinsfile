pipeline {
  agent any

  environment {
    TF_VAR_aws_region = 'us-east-1'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Init & Plan (in terraform-jenkins)') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws-jenkins-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          dir('terraform-jenkins') {
            sh '''
              echo "Working dir: $(pwd)"
              echo "Region: $TF_VAR_aws_region"
              terraform --version
              terraform init -input=false
              terraform plan -out=tfplan -input=false
            '''
          }
        }
        // tfplan file is inside terraform-jenkins, so archive with that path
        archiveArtifacts artifacts: 'terraform-jenkins/tfplan', onlyIfSuccessful: true
      }
    }

    stage('Manual Approval & Apply') {
      steps {
        input message: "Apply terraform plan to create EC2 instances?", ok: "Apply"
        withCredentials([usernamePassword(credentialsId: 'aws-jenkins-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          dir('terraform-jenkins') {
            sh 'terraform apply -input=false tfplan'
          }
        }
      }
    }

    stage('Outputs') {
      steps {
        dir('terraform-jenkins') {
          sh '''
            terraform output -json > outputs.json
            cat outputs.json
          '''
          archiveArtifacts artifacts: 'terraform-jenkins/outputs.json', onlyIfSuccessful: true
        }
      }
    }
  }

  post {
    success { echo 'Terraform apply succeeded' }
    failure { echo 'Terraform pipeline failed' }
  }
}
