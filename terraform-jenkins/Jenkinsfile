// Jenkinsfile — final corrected pipeline (region: us-east-1)
// - Credentials (Global): aws-access-key-id, aws-secret-access-key
// - Set TERRAFORM_DIR below if your .tf files live in a subfolder (default 'terraform-jenkins')

pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    TERRAFORM_BIN = '/usr/local/bin/terraform'
    TERRAFORM_DIR = 'terraform-jenkins'   // <-- change to '' if .tf files are in repo root
  }

  options {
    buildDiscarder(logRotator(daysToKeepStr: '14'))
    timeout(time: 60, unit: 'MINUTES')
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Checking out repo..."
        git branch: 'main', url: 'https://github.com/GalamManesha/kubernetes.git'
      }
    }

    stage('Locate Terraform') {
      steps {
        script {
          // prefer terraform in PATH, otherwise fallback to TERRAFORM_BIN
          def tf = sh(script: "command -v terraform || echo ${TERRAFORM_BIN}", returnStdout: true).trim()
          env.TF_BIN = tf
          echo "Terraform binary: ${env.TF_BIN}"
        }
        sh "${env.TF_BIN} --version"
      }
    }

    stage('Fmt') {
      steps {
        script {
          if (env.TERRAFORM_DIR?.trim()) {
            sh "${env.TF_BIN} fmt -recursive ${env.TERRAFORM_DIR} || true"
          } else {
            sh "${env.TF_BIN} fmt -recursive || true"
          }
        }
      }
    }

    stage('Init') {
      steps {
        script {
          if (env.TERRAFORM_DIR?.trim()) {
            sh "cd ${env.TERRAFORM_DIR} && ${env.TF_BIN} init -input=false"
          } else {
            sh "${env.TF_BIN} init -input=false"
          }
        }
      }
    }

    stage('Validate') {
      steps {
        script {
          if (env.TERRAFORM_DIR?.trim()) {
            sh "cd ${env.TERRAFORM_DIR} && ${env.TF_BIN} validate || true"
          } else {
            sh "${env.TF_BIN} validate || true"
          }
        }
      }
    }

    stage('Plan') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          script {
            if (env.TERRAFORM_DIR?.trim()) {
              sh "cd ${env.TERRAFORM_DIR} && export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} && ${env.TF_BIN} plan -out=tfplan -input=false"
              sh "cd ${env.TERRAFORM_DIR} && ${env.TF_BIN} show -no-color tfplan"
              archiveArtifacts artifacts: "${env.TERRAFORM_DIR}/tfplan", onlyIfSuccessful: true
            } else {
              sh "export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} && ${env.TF_BIN} plan -out=tfplan -input=false"
              sh "${env.TF_BIN} show -no-color tfplan"
              archiveArtifacts artifacts: "tfplan", onlyIfSuccessful: true
            }
          }
        }
      }
    }

    stage('Apply (auto)') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          script {
            if (env.TERRAFORM_DIR?.trim()) {
              sh "cd ${env.TERRAFORM_DIR} && export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} && ${env.TF_BIN} apply -auto-approve tfplan"
            } else {
              sh "export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} && ${env.TF_BIN} apply -auto-approve tfplan"
            }
          }
        }
      }
    }
  }

  post {
    success { echo "✅ Terraform completed successfully." }
    failure { echo "❌ Terraform pipeline failed — see console for details." }
    always  { echo "Finished at: ${new Date()}" }
  }
}
